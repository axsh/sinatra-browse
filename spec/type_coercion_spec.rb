# -*- coding: utf-8 -*-

require "spec_helper"

describe "type coercion" do
  it "coerces parameters into the defined types" do
    get("features/type_coercion",
      string: "joske",
      integer: "1",
      boolean: "false",
      float: "1.5",
      hash: {joske: :jefke},
      array: [1, 2, 3]
    )

    expect(body['string']).to be_a(String)
    expect(body['integer']).to be_a(Integer)
    expect(body['boolean']).to be_a(FalseClass)
    expect(body['float']).to be_a(Float)
    expect(body['hash']).to be_a(Hash)
    expect(body['array']).to be_a(Array)
  end

  describe "Any coercion" do
    it "accepts any type of parameter and does not do any type coercion" do
      get("features/type_coercion", any: "olifant")
      expect(body["any"]).to eq "olifant"

      get("features/type_coercion", any: 1)
      expect(body["any"]).to eq "1"

      get("features/type_coercion", any: true)
      expect(body["any"]).to eq "true"

      get("features/type_coercion", any: {a: :b, c: :d})
      expect(body["any"]).to eq({"a" => "b", "c" => "d"})

      get("features/type_coercion", any: [1, 2, 3, 4, "hoedje van"])
      expect(body["any"]).to eq ["1", "2", "3", "4", "hoedje van"]
    end
  end

  describe "Hash coercion" do
    it "accepts hash parameters" do
      get("features/type_coercion", "hash[t]=t&hash[f]=f")
      expect(body['hash']).to eq({
        "t" => "t",
        "f" => "f"
      })
    end

    it "returns an error hash and http status 400 for anything else" do
      get("features/type_coercion", hash: "screw!")
      expect(last_response.status).to eq 400
      expect(body).to eq({
        "error" => "parameter validation failed",
        "parameter" => "hash",
        "value" => "screw!",
        "reason" => "Unable to coerce 'screw!' to hash. It does not have a to_hash method."
      })
    end
  end

  describe "Array coercion" do
    it "accepts array parameters" do
      get("features/type_coercion", "array[]=foo&array[]=bar")
      expect(body['array']).to eq(["foo", "bar"])
    end

    it "returns an error hash and http status 400 for anything else" do
      get("features/type_coercion", array: "screw!")
      expect(last_response.status).to eq 400
      expect(body).to eq({
        "error" => "parameter validation failed",
        "parameter" => "array",
        "value" => "screw!",
        "reason" => "Unable to coerce 'screw!' to array. It does not have a to_a method."
      })
    end
  end

  describe "DateTime coercion" do
    accepted_formats = [
      ['RFC 2616', 'Sat, 03 Feb 2001 04:05:06 GMT', '2001-02-03T04:05:06+00:00'],
      ['RFC 2822', 'Sat, 3 Feb 2001 04:05:06 +0700', '2001-02-03T04:05:06+07:00'],
      ['RFC 3339', '2001-02-03T04:05:06+07:00', '2001-02-03T04:05:06+07:00'],
      ['ISO 8601', '2001-02-03T04:05:06+07:00', '2001-02-03T04:05:06+07:00'],
      ['JIS X 0301', 'H13.02.03T04:05:06+07:00', '2001-02-03T04:05:06+07:00'],
      ['year/month/day', '2014/02/05', '2014-02-05T00:00:00+00:00'],
      ['generic text', 'march 2nd', "#{Time.now.year}-03-02T00:00:00+00:00"]
    ]

    accepted_formats.each { |format_name, request_param, expected_response|
      it "coerces a #{format_name} string into a DateTime" do
        get("features/type_coercion", date: request_param)
        expect(body["date"]).to eq expected_response
      end
    }
  end

  describe "Boolean coercion" do
    B = Sinatra::Browse::ParameterTypes::Boolean

    B::TRUE_VALUES.each do |i|
      it "coerces true for '#{i}'" do
        get("features/type_coercion", boolean: i)
        expect(body['boolean']).to be_a(TrueClass)
      end
    end

    B::FALSE_VALUES.each do |i|
      it "coerces false for '#{i}'" do
        get("features/type_coercion", boolean: i)
        expect(body['boolean']).to be_a(FalseClass)
      end
    end

    it "returns an error hash and http status 400 for anything else" do
      get("features/type_coercion", boolean: "far lands or bust")
      expect(status).to eq 400
      expect(body).to eq({
        "error" => "parameter validation failed",
        "parameter" => "boolean",
        "value" => "far lands or bust",
        "reason" => "Not a valid boolean value: 'far lands or bust'. Must be one of the following: #{B::TRUE_VALUES + B::FALSE_VALUES}"
      })
    end
  end
end
